# Architecture Technique ComplÃ¨te - CampusLink

---

## ğŸ“‹ Table des MatiÃ¨res

1. [VÃ©rification des Utilisateurs (SimplifiÃ©e)](#vÃ©rification)
2. [Structure ComplÃ¨te des Dossiers](#structure)
3. [Base de DonnÃ©es (OptimisÃ©e)](#database)
4. [SchÃ©ma Relationnel](#schema)
5. [Endpoints API Complets](#endpoints)
6. [SÃ©curitÃ© et Performance](#security)
7. [Tests et QualitÃ©](#tests)
8. [DÃ©ploiement](#deployment)

---

## ğŸ” 1. VÃ©rification des Utilisateurs (Approche SimplifiÃ©e) {#vÃ©rification}

### Philosophie : Progressive et SÃ©curisÃ©e

**Phase 1 (MVP) - VÃ©rification SimplifiÃ©e :**
- **Email universitaire** : Validation automatique des domaines (@esmt.sn, @ucad.sn, @ugb.sn, etc.)
- **TÃ©lÃ©phone** : OTP SMS obligatoire pour tous (via Twilio ou Orange API)
- **RÃ©sultat** : Utilisateurs vÃ©rifiÃ©s peuvent crÃ©er Ã©vÃ©nements, posts publics, etc.

**Phase 2 (Post-MVP) - VÃ©rification AvancÃ©e :**
- **Matricule** : Optionnel, validation manuelle par admin (ou auto si regex par universitÃ©)
- **Documents** : Pour sponsors/associations (upload et validation admin)

### Flux de VÃ©rification (Phase 1)

```
1. Inscription
   â”œâ”€ Email (validation domaine universitaire)
   â”œâ”€ TÃ©lÃ©phone (format +221XXXXXXXXX)
   â””â”€ Envoi OTP SMS automatique

2. VÃ©rification Email
   â”œâ”€ Token envoyÃ© Ã  university_email
   â”œâ”€ Clic sur lien â†’ verification_status = 'verified'
   â””â”€ Notification de succÃ¨s

3. VÃ©rification TÃ©lÃ©phone
   â”œâ”€ OTP envoyÃ© via SMS
   â”œâ”€ Utilisateur entre code (6 chiffres, valide 10 min)
   â””â”€ Si correct â†’ phone_verified = True

4. Statut Final
   â”œâ”€ is_verified = True si (email_verified AND phone_verified)
   â”œâ”€ AccÃ¨s complet aux fonctionnalitÃ©s
   â””â”€ Peut crÃ©er Ã©vÃ©nements, posts publics, etc.
```

### Restrictions par Statut

| Action                    | Non vÃ©rifiÃ© | VÃ©rifiÃ© (Email + Phone) |
| ------------------------- | ----------- | ----------------------- |
| Voir Ã©vÃ©nements           | âœ…          | âœ…                       |
| Participer Ã  Ã©vÃ©nements   | âœ…          | âœ…                       |
| CrÃ©er Ã©vÃ©nement           | âŒ          | âœ…                       |
| CrÃ©er post public         | âŒ          | âœ…                       |
| CrÃ©er groupe              | âŒ          | âœ…                       |
| Acheter billet            | âŒ          | âœ…                       |
| Envoyer messages          | âœ…          | âœ…                       |
| Commenter                 | âœ…          | âœ…                       |

---

## ğŸ“ 2. Structure ComplÃ¨te des Dossiers {#structure}

```
campuslink/
â”‚
â”œâ”€â”€ backend/                          # Django Backend
â”‚   â”œâ”€â”€ campuslink/                   # Projet principal Django
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ settings.py               # Configuration Django (env vars)
â”‚   â”‚   â”œâ”€â”€ urls.py                   # URLs principales
â”‚   â”‚   â”œâ”€â”€ wsgi.py
â”‚   â”‚   â”œâ”€â”€ asgi.py                   # Pour WebSockets (Channels)
â”‚   â”‚   â””â”€â”€ middleware.py             # Rate limiting, CORS, security
â”‚   â”‚
â”‚   â”œâ”€â”€ users/                        # App Utilisateurs
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py                 # User, Profile, Friendship, Follow
â”‚   â”‚   â”œâ”€â”€ views.py                  # Vues API utilisateurs
â”‚   â”‚   â”œâ”€â”€ serializers.py            # Serializers DRF
â”‚   â”‚   â”œâ”€â”€ urls.py                   # Routes utilisateurs
â”‚   â”‚   â”œâ”€â”€ permissions.py            # Permissions custom (IsVerified)
â”‚   â”‚   â”œâ”€â”€ signals.py                # Signaux (auto-create profile)
â”‚   â”‚   â”œâ”€â”€ verification.py           # Logique vÃ©rification (OTP, email)
â”‚   â”‚   â”œâ”€â”€ throttling.py              # Rate limiting par endpoint
â”‚   â”‚   â”œâ”€â”€ validators.py             # Validation email universitaire, tÃ©lÃ©phone
â”‚   â”‚   â”œâ”€â”€ admin.py                  # Admin Django (panels vÃ©rification)
â”‚   â”‚   â””â”€â”€ tests/                    # Tests unitaires et intÃ©gration
â”‚   â”‚       â”œâ”€â”€ test_models.py
â”‚   â”‚       â”œâ”€â”€ test_views.py
â”‚   â”‚       â””â”€â”€ test_verification.py
â”‚   â”‚
â”‚   â”œâ”€â”€ events/                        # App Ã‰vÃ©nements
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py                 # Event, Category, Participation, Comment, Like
â”‚   â”‚   â”œâ”€â”€ views.py                  # CRUD Ã©vÃ©nements (check verified)
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â”œâ”€â”€ filters.py                # Filtres pour recherche avancÃ©e
â”‚   â”‚   â”œâ”€â”€ permissions.py            # IsVerifiedOrReadOnly
â”‚   â”‚   â”œâ”€â”€ admin.py
â”‚   â”‚   â””â”€â”€ tests/
â”‚   â”‚
â”‚   â”œâ”€â”€ groups/                        # App Groupes/Clubs (Post-MVP)
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ models.py                 # Group, Membership, GroupPost
â”‚   â”‚   â”œâ”€â”€ views.py                  # CRUD groupes (check verified)
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â”‚
â”‚   â”œâ”€â”€ messaging/                     # App Messages/Chat (Post-MVP)
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ models.py                 # Conversation, Participant, Message
â”‚   â”‚   â”œâ”€â”€ views.py
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â”œâ”€â”€ consumers.py              # WebSocket pour chat temps rÃ©el
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â”‚
â”‚   â”œâ”€â”€ notifications/                 # App Notifications
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ models.py                 # Notification
â”‚   â”‚   â”œâ”€â”€ views.py
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â”œâ”€â”€ tasks.py                  # Celery tasks (OTP/SMS, emails)
â”‚   â”‚   â”œâ”€â”€ utils.py                  # Fonctions crÃ©ation notifications
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â”‚
â”‚   â”œâ”€â”€ payments/                      # App Paiements/Billetterie (Post-MVP)
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ models.py                 # Payment, Ticket
â”‚   â”‚   â”œâ”€â”€ views.py                  # Stripe/PayPal integration
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â”‚
â”‚   â”œâ”€â”€ social/                        # App Interactions Sociales
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ models.py                 # Post, PostComment, PostLike
â”‚   â”‚   â”œâ”€â”€ views.py                  # CRUD posts (check verified)
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â”œâ”€â”€ permissions.py            # IsVerifiedForPublicPosts
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â”‚
â”‚   â”œâ”€â”€ moderation/                    # App ModÃ©ration (Nouveau)
â”‚   â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ models.py                 # Report, ModerationAction, AuditLog
â”‚   â”‚   â”œâ”€â”€ views.py                  # Endpoints signalement, modÃ©ration
â”‚   â”‚   â”œâ”€â”€ serializers.py
â”‚   â”‚   â”œâ”€â”€ urls.py
â”‚   â”‚   â”œâ”€â”€ tasks.py                  # ModÃ©ration automatique (mots-clÃ©s)
â”‚   â”‚   â””â”€â”€ admin.py
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                          # App Core (Nouveau)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ cache.py                  # Utilitaires Redis
â”‚   â”‚   â”œâ”€â”€ pagination.py             # Pagination custom
â”‚   â”‚   â”œâ”€â”€ exceptions.py             # Exceptions custom
â”‚   â”‚   â””â”€â”€ utils.py                  # Fonctions utilitaires
â”‚   â”‚
â”‚   â”œâ”€â”€ media/                         # Fichiers uploadÃ©s (dev)
â”‚   â”‚   â”œâ”€â”€ profiles/
â”‚   â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”œâ”€â”€ groups/
â”‚   â”‚   â””â”€â”€ posts/
â”‚   â”‚
â”‚   â”œâ”€â”€ static/                        # Fichiers statiques
â”‚   â”‚
â”‚   â”œâ”€â”€ requirements.txt               # DÃ©pendances Python
â”‚   â”œâ”€â”€ requirements-dev.txt           # DÃ©pendances dÃ©veloppement
â”‚   â”œâ”€â”€ manage.py
â”‚   â”œâ”€â”€ .env.example                   # Template variables d'environnement
â”‚   â”œâ”€â”€ pytest.ini                     # Configuration pytest
â”‚   â””â”€â”€ docker-compose.yml             # Pour dÃ©veloppement local
â”‚
â”œâ”€â”€ frontend/                          # React/Next.js PWA
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”œâ”€â”€ icons/
â”‚   â”‚   â”œâ”€â”€ manifest.json              # PWA manifest
â”‚   â”‚   â””â”€â”€ service-worker.js          # Service Worker
â”‚   â”‚
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/                # Composants rÃ©utilisables
â”‚   â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Button.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Card.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Modal.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OTPModal.jsx       # Modal OTP pour tÃ©lÃ©phone
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Navbar.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoadingSpinner.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ErrorMessage.jsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EventCard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EventList.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EventDetails.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EventForm.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EventMap.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EventComments.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EventParticipants.jsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileCard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserList.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileEdit.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ VerificationBadge.jsx # Badge statut vÃ©rification
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FriendsList.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FollowersList.jsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ social/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PostCard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PostForm.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CommentSection.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LikeButton.jsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ onboarding/            # Nouveau : Onboarding progressif
â”‚   â”‚   â”‚       â”œâ”€â”€ Step1Email.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ Step2Phone.jsx
â”‚   â”‚   â”‚       â””â”€â”€ Step3Complete.jsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pages/                     # Pages Next.js
â”‚   â”‚   â”‚   â”œâ”€â”€ _app.js
â”‚   â”‚   â”‚   â”œâ”€â”€ _document.js
â”‚   â”‚   â”‚   â”œâ”€â”€ index.js               # Feed principal
â”‚   â”‚   â”‚   â”œâ”€â”€ login.js
â”‚   â”‚   â”‚   â”œâ”€â”€ register.js            # Inscription avec vÃ©rification
â”‚   â”‚   â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.js           # Liste Ã©vÃ©nements
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ [id].js            # DÃ©tail Ã©vÃ©nement
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ create.js          # CrÃ©er Ã©vÃ©nement
â”‚   â”‚   â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ [id].js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ edit.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ verify.js          # Page vÃ©rification
â”‚   â”‚   â”‚   â””â”€â”€ feed/
â”‚   â”‚   â”‚       â””â”€â”€ index.js           # Feed social
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ services/                  # API calls
â”‚   â”‚   â”‚   â”œâ”€â”€ api.js                 # Config axios (interceptors, errors)
â”‚   â”‚   â”‚   â”œâ”€â”€ authService.js         # verifyPhone, verifyEmail
â”‚   â”‚   â”‚   â”œâ”€â”€ eventService.js
â”‚   â”‚   â”‚   â”œâ”€â”€ userService.js
â”‚   â”‚   â”‚   â”œâ”€â”€ socialService.js
â”‚   â”‚   â”‚   â””â”€â”€ notificationService.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ hooks/                     # Custom hooks
â”‚   â”‚   â”‚   â”œâ”€â”€ useAuth.js             # check verification status
â”‚   â”‚   â”‚   â”œâ”€â”€ useEvents.js
â”‚   â”‚   â”‚   â”œâ”€â”€ useSocial.js
â”‚   â”‚   â”‚   â”œâ”€â”€ useNotifications.js
â”‚   â”‚   â”‚   â””â”€â”€ useVerification.js     # Nouveau : hook vÃ©rification
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ context/                   # Context API
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthContext.js
â”‚   â”‚   â”‚   â”œâ”€â”€ ThemeContext.js        # Mode sombre
â”‚   â”‚   â”‚   â””â”€â”€ SocketContext.js
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ styles/                    # CSS/SCSS
â”‚   â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils/                     # Fonctions utilitaires
â”‚   â”‚       â”œâ”€â”€ formatDate.js
â”‚   â”‚       â”œâ”€â”€ validators.js          # validateMatricule, validatePhone, validateEmail
â”‚   â”‚       â””â”€â”€ constants.js           # universityDomains, etc.
â”‚   â”‚
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ next.config.js
â”‚   â”œâ”€â”€ .env.local.example
â”‚   â””â”€â”€ jest.config.js                 # Tests frontend
â”‚
â””â”€â”€ docs/                              # Documentation
    â”œâ”€â”€ API.md                         # Documentation API (Swagger/OpenAPI)
    â”œâ”€â”€ DATABASE.md                    # SchÃ©ma BDD dÃ©taillÃ©
    â”œâ”€â”€ DEPLOYMENT.md                  # Guide dÃ©ploiement
    â”œâ”€â”€ SECURITY.md                    # Guide sÃ©curitÃ©
    â”œâ”€â”€ TESTING.md                     # Guide tests
    â””â”€â”€ COMMANDS.md                    # Toutes les commandes
```

---

## ğŸ—„ï¸ 3. Base de DonnÃ©es (OptimisÃ©e avec Index) {#database}

### 3.1 Table: users_user (Utilisateurs)

```sql
CREATE TABLE users_user (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(150) UNIQUE NOT NULL,
    password VARCHAR(128) NOT NULL,  -- Hashed avec bcrypt/Argon2
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    role VARCHAR(20) NOT NULL DEFAULT 'student',  -- ENUM: 'student', 'association', 'sponsor', 'admin'
    phone_number VARCHAR(20) NOT NULL,  -- Format: +221XXXXXXXXX
    phone_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,  -- True si email_verified AND phone_verified
    verification_status VARCHAR(20) DEFAULT 'pending',  -- ENUM: 'pending', 'verified', 'rejected'
    last_activity TIMESTAMP,  -- Pour dÃ©tecter utilisateurs inactifs
    date_joined TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP,
    
    -- Indexes pour performance
    INDEX idx_user_email (email),
    INDEX idx_user_username (username),
    INDEX idx_user_phone (phone_number),
    INDEX idx_user_verification_status (verification_status),
    INDEX idx_user_is_verified (is_verified),
    INDEX idx_user_last_activity (last_activity)
);
```

### 3.2 Table: users_profile (Profils Ã©tudiants)

```sql
CREATE TABLE users_profile (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL REFERENCES users_user(id) ON DELETE CASCADE,
    university VARCHAR(200),
    campus VARCHAR(200),
    field_of_study VARCHAR(200),
    academic_year VARCHAR(50),
    bio TEXT,
    profile_picture VARCHAR(500),  -- URL Cloudinary/S3
    cover_picture VARCHAR(500),
    date_of_birth DATE,
    interests JSONB,  -- ['sports', 'music', 'tech']
    location POINT,  -- Pour gÃ©olocalisation (PostGIS)
    website VARCHAR(500),
    facebook VARCHAR(100),
    instagram VARCHAR(100),
    twitter VARCHAR(100),
    followers_count INTEGER DEFAULT 0,
    following_count INTEGER DEFAULT 0,
    friends_count INTEGER DEFAULT 0,
    university_email VARCHAR(255),  -- Email universitaire pour vÃ©rification
    email_verified BOOLEAN DEFAULT FALSE,
    student_id VARCHAR(50),  -- Matricule (chiffrÃ© en base)
    verification_method VARCHAR(20),  -- ENUM: 'email', 'phone', 'matricule', 'manual'
    reputation_score INTEGER DEFAULT 0,  -- Score de rÃ©putation (anti-abus)
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- Indexes
    INDEX idx_profile_user_id (user_id),
    INDEX idx_profile_university (university),
    INDEX idx_profile_student_id (student_id),
    INDEX idx_profile_email_verified (email_verified),
    INDEX idx_profile_reputation (reputation_score)
);
```

### 3.3 Table: events_event (Ã‰vÃ©nements)

```sql
CREATE TABLE events_event (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    organizer_id UUID NOT NULL REFERENCES users_user(id) ON DELETE CASCADE,
    category_id UUID REFERENCES events_category(id),
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP,
    location VARCHAR(500),
    location_point POINT,  -- Pour carte (PostGIS)
    image_url VARCHAR(500),
    capacity INTEGER,
    price DECIMAL(10, 2) DEFAULT 0.00,
    is_free BOOLEAN DEFAULT TRUE,
    registration_link VARCHAR(500),  -- Lien externe si besoin
    status VARCHAR(20) DEFAULT 'draft',  -- ENUM: 'draft', 'published', 'cancelled', 'completed'
    is_featured BOOLEAN DEFAULT FALSE,  -- Pour sponsoring
    views_count INTEGER DEFAULT 0,
    participants_count INTEGER DEFAULT 0,
    likes_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- Indexes
    INDEX idx_event_organizer (organizer_id),
    INDEX idx_event_category (category_id),
    INDEX idx_event_start_date (start_date),
    INDEX idx_event_status (status),
    INDEX idx_event_location (location_point),  -- Pour recherche gÃ©ographique
    INDEX idx_event_created (created_at)
);
```

### 3.4 Table: moderation_auditlog (Audit Log - Nouveau)

```sql
CREATE TABLE moderation_auditlog (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users_user(id),
    action_type VARCHAR(50) NOT NULL,  -- 'create_event', 'create_post', 'report', etc.
    resource_type VARCHAR(50),  -- 'event', 'post', 'user', etc.
    resource_id UUID,
    ip_address INET,
    user_agent TEXT,
    details JSONB,  -- DÃ©tails supplÃ©mentaires
    created_at TIMESTAMP DEFAULT NOW(),
    
    -- Indexes
    INDEX idx_audit_user (user_id),
    INDEX idx_audit_action (action_type),
    INDEX idx_audit_created (created_at)
);
```

### 3.5 Autres Tables Importantes

**events_participation** : Participation aux Ã©vÃ©nements
**social_post** : Posts sociaux
**social_postcomment** : Commentaires sur posts
**users_friendship** : Relations d'amitiÃ©
**users_follow** : SystÃ¨me de followers
**notifications_notification** : Notifications utilisateurs
**moderation_report** : Signalements (nouveau)

---

## ğŸ”— 4. SchÃ©ma Relationnel {#schema}

```
USER (1) â”€â”€â”€â”€â”€â”€â”€ (1) PROFILE
  â”‚
  â”œâ”€â”€â”€â”€ (N,M) FRIENDSHIP (from_user, to_user)
  â”‚
  â”œâ”€â”€â”€â”€ (N,M) FOLLOW (follower, following)
  â”‚
  â”œâ”€â”€â”€â”€ (1,N) EVENT (organizer) [CONTRAINTE: organizer.is_verified = True]
  â”‚ â”‚
  â”‚ â”œâ”€â”€â”€â”€ (N,M) PARTICIPATION
  â”‚ â”‚
  â”‚ â”œâ”€â”€â”€â”€ (1,N) EVENT_COMMENT
  â”‚ â”‚
  â”‚ â”œâ”€â”€â”€â”€ (N,M) EVENT_LIKE
  â”‚ â”‚
  â”‚ â””â”€â”€â”€â”€ (N,1) CATEGORY
  â”‚
  â”œâ”€â”€â”€â”€ (1,N) SOCIAL_POST [CONTRAINTE: author.is_verified = True pour public]
  â”‚ â”‚
  â”‚ â”œâ”€â”€â”€â”€ (N,M) POST_LIKE
  â”‚ â”‚
  â”‚ â””â”€â”€â”€â”€ (1,N) POST_COMMENT
  â”‚
  â”œâ”€â”€â”€â”€ (1,N) GROUP (creator) [CONTRAINTE: creator.is_verified = True]
  â”‚
  â”œâ”€â”€â”€â”€ (1,N) MESSAGE (sender)
  â”‚
  â”œâ”€â”€â”€â”€ (1,N) NOTIFICATION (recipient)
  â”‚
  â”œâ”€â”€â”€â”€ (1,N) PAYMENT [CONTRAINTE: user.is_verified = True]
  â”‚
  â””â”€â”€â”€â”€ (1,N) AUDIT_LOG (pour traÃ§abilitÃ©)
```

---

## ğŸ“¡ 5. Endpoints API Complets {#endpoints}

### AUTH & VÃ‰RIFICATION

```
POST   /api/auth/register/              # Inscription (phone + email requis pour students)
POST   /api/auth/login/                 # Connexion (JWT)
POST   /api/auth/logout/                # DÃ©connexion
POST   /api/auth/token/refresh/         # Refresh JWT token
GET    /api/auth/profile/                # Profil user connectÃ© (inclut verification_status)
PUT    /api/auth/profile/                # Modifier profil
POST   /api/auth/change-password/       # Changer mot de passe

POST   /api/auth/verify-phone/           # Envoyer OTP SMS
POST   /api/auth/verify-phone/confirm/   # Confirmer OTP
POST   /api/auth/verify-email/           # Envoyer lien vÃ©rification email
GET    /api/auth/verify-email/{token}/  # VÃ©rifier email (lien)
GET    /api/auth/verification-status/   # Statut vÃ©rification actuel
```

### USERS & SOCIAL

```
GET    /api/users/                      # Liste utilisateurs (filtre: verified_only)
GET    /api/users/{id}/                 # Profil utilisateur
GET    /api/users/{id}/posts/           # Posts d'un utilisateur
GET    /api/users/{id}/events/          # Ã‰vÃ©nements d'un utilisateur

# Amis
GET    /api/users/friends/              # Liste amis
POST   /api/users/friends/request/      # Demande d'ami [VERIFIED]
PUT    /api/users/friends/{id}/accept/  # Accepter
PUT    /api/users/friends/{id}/reject/  # Refuser
DELETE /api/users/friends/{id}/         # Supprimer ami

# Followers
GET    /api/users/{id}/followers/       # Liste followers
GET    /api/users/{id}/following/       # Liste following
POST   /api/users/{id}/follow/          # Suivre [VERIFIED]
DELETE /api/users/{id}/unfollow/       # Ne plus suivre
```

### EVENTS

```
GET    /api/events/                     # Liste Ã©vÃ©nements (+ filtres, pagination)
POST   /api/events/                     # CrÃ©er Ã©vÃ©nement [VERIFIED]
GET    /api/events/{id}/                # DÃ©tails Ã©vÃ©nement
PUT    /api/events/{id}/                 # Modifier Ã©vÃ©nement (owner only)
DELETE /api/events/{id}/                # Supprimer Ã©vÃ©nement (owner only)
POST   /api/events/{id}/participate/    # Participer [VERIFIED]
DELETE /api/events/{id}/leave/          # Quitter
GET    /api/events/categories/          # Liste catÃ©gories
GET    /api/events/{id}/participants/   # Liste participants (paginated)

# Commentaires
GET    /api/events/{id}/comments/       # Liste commentaires
POST   /api/events/{id}/comments/       # Ajouter commentaire [VERIFIED]
PUT    /api/events/comments/{id}/       # Modifier commentaire
DELETE /api/events/comments/{id}/       # Supprimer commentaire

# Likes
POST   /api/events/{id}/like/           # Liker
DELETE /api/events/{id}/unlike/         # Unliker
GET    /api/events/{id}/likes/          # Liste des likes
```

### POSTS SOCIAUX

```
GET    /api/feed/                       # Feed principal (priorise verified, paginated)
GET    /api/posts/                      # Mes posts
POST   /api/posts/                      # CrÃ©er post [VERIFIED pour public]
GET    /api/posts/{id}/                 # DÃ©tails post
PUT    /api/posts/{id}/                 # Modifier post
DELETE /api/posts/{id}/                 # Supprimer post

# Commentaires
GET    /api/posts/{id}/comments/       # Liste commentaires
POST   /api/posts/{id}/comments/        # Ajouter commentaire
DELETE /api/posts/comments/{id}/        # Supprimer commentaire

# Likes
POST   /api/posts/{id}/like/            # Liker
DELETE /api/posts/{id}/unlike/          # Unliker

# Partage
POST   /api/posts/{id}/share/           # Partager
```

### MODÃ‰RATION

```
POST   /api/moderation/report/           # Signaler contenu/utilisateur
GET    /api/moderation/reports/         # Liste signalements (admin only)
PUT    /api/moderation/reports/{id}/     # Traiter signalement (admin)
GET    /api/moderation/audit-log/        # Log d'audit (admin only)
```

### NOTIFICATIONS

```
GET    /api/notifications/              # Liste notifications (paginated)
PUT    /api/notifications/{id}/read/    # Marquer comme lu
PUT    /api/notifications/read-all/     # Tout marquer comme lu
```

---

## ğŸ”’ 6. SÃ©curitÃ© et Performance {#security}

### SÃ©curitÃ©

**Rate Limiting (via django-ratelimit ou Redis) :**
- Inscription : 3 tentatives/heure par IP
- OTP : 5 tentatives/heure par tÃ©lÃ©phone
- Login : 5 tentatives/15 minutes
- API gÃ©nÃ©rale : 100 requÃªtes/minute par utilisateur authentifiÃ©

**JWT Tokens :**
- Access token : 15 minutes
- Refresh token : 7 jours (rotation automatique)
- Blacklist des tokens rÃ©voquÃ©s (Redis)

**Validation CÃ´tÃ© Serveur :**
- Domaines email universitaires : liste blanche (@esmt.sn, @ucad.sn, etc.)
- Format tÃ©lÃ©phone : validation regex (+221XXXXXXXXX)
- Chiffrement matricules : AES-256 avant stockage

**Protection :**
- CORS configurÃ© (origins autorisÃ©es uniquement)
- CSRF protection activÃ©e
- XSS protection (sanitization des inputs)
- SQL Injection : ORM Django (parametrized queries)

### Performance

**Redis Cache :**
- Feed Ã©vÃ©nements populaires : TTL 5 minutes
- Profils utilisateurs frÃ©quents : TTL 10 minutes
- Sessions utilisateurs
- Rate limiting counters

**Optimisations Base de DonnÃ©es :**
- Index sur colonnes frÃ©quemment queryÃ©es (voir schÃ©ma)
- Pagination sur toutes les listes (20 items/page par dÃ©faut)
- Select_related / Prefetch_related pour Ã©viter N+1 queries

**CDN :**
- Images/vidÃ©os via Cloudinary ou S3 + CloudFront
- Assets statiques via Vercel CDN

**Monitoring :**
- Sentry pour erreurs
- Logs structurÃ©s (JSON)
- MÃ©triques de performance (temps de rÃ©ponse API)

---

## ğŸ§ª 7. Tests et QualitÃ© {#tests}

### Backend (Django)

**Tests Unitaires :**
- Models (validation, contraintes)
- Serializers (validation donnÃ©es)
- Utilitaires (vÃ©rification, validators)

**Tests d'IntÃ©gration :**
- Endpoints API (workflows complets)
- VÃ©rification utilisateurs (OTP, email)
- Permissions (IsVerified)

**Tests E2E :**
- Workflow inscription â†’ vÃ©rification â†’ crÃ©ation Ã©vÃ©nement
- Workflow participation â†’ paiement (si billetterie)

**Coverage :**
- Objectif : 80%+ de couverture de code
- Outil : pytest-cov

### Frontend (Next.js)

**Tests Unitaires :**
- Composants React (Jest + React Testing Library)
- Hooks custom
- Utilitaires

**Tests E2E :**
- Playwright ou Cypress
- ScÃ©narios critiques (inscription, crÃ©ation Ã©vÃ©nement)

---

## ğŸš€ 8. DÃ©ploiement {#deployment}

### Environnements

**Development :**
- Backend : local (Django runserver)
- Frontend : local (Next.js dev server)
- Database : PostgreSQL local ou Supabase (dev)
- Redis : local ou Upstash (dev)

**Staging :**
- Backend : Render/Railway (staging)
- Frontend : Vercel (preview)
- Database : Supabase (staging)
- Redis : Upstash (staging)

**Production :**
- Backend : Render/Railway (production)
- Frontend : Vercel (production)
- Database : Supabase (production) ou Railway PostgreSQL
- Redis : Upstash (production)
- CDN : Cloudinary/S3

### Variables d'Environnement

**Backend (.env) :**
```
SECRET_KEY=...
DEBUG=False
ALLOWED_HOSTS=...
DATABASE_URL=...
REDIS_URL=...
TWILIO_ACCOUNT_SID=...
TWILIO_AUTH_TOKEN=...
SENTRY_DSN=...
CLOUDINARY_URL=...
EMAIL_HOST=...
EMAIL_PORT=...
```

**Frontend (.env.local) :**
```
NEXT_PUBLIC_API_URL=https://api.campuslink.sn
NEXT_PUBLIC_FCM_KEY=...
NEXT_PUBLIC_SENTRY_DSN=...
```

### CI/CD

**GitHub Actions :**
- Tests automatiques sur chaque PR
- Lint (Black, ESLint)
- Build et dÃ©ploiement automatique sur merge main

---

**Document crÃ©Ã© le :** 2024
**Version :** 2.0 (AmÃ©liorÃ©e avec suggestions techniques)
