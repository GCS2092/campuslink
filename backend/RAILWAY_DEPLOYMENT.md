# Guide de D√©ploiement Backend sur Railway

## üìã Pr√©requis

1. Compte Railway (gratuit) : https://railway.app
2. Compte GitHub
3. Votre repo GitHub avec le code backend

## üöÄ D√©ploiement sur Railway

### √âtape 1 : Cr√©er un Projet Railway

1. Allez sur https://railway.app
2. Cliquez sur "New Project"
3. S√©lectionnez "Deploy from GitHub repo"
4. Autorisez Railway √† acc√©der √† votre GitHub
5. S√©lectionnez votre repo `campusLink`

### √âtape 2 : Ajouter PostgreSQL

1. Dans votre projet Railway, cliquez sur "+ New"
2. S√©lectionnez "Database" ‚Üí "PostgreSQL"
3. Railway cr√©era automatiquement une base PostgreSQL
4. Notez les variables d'environnement (DATABASE_URL sera cr√©√© automatiquement)

### √âtape 3 : Configurer le Service Django

1. Cliquez sur "+ New" ‚Üí "GitHub Repo"
2. S√©lectionnez votre repo
3. Railway d√©tectera automatiquement Django

### √âtape 4 : Configurer les Variables d'Environnement

Dans Railway ‚Üí Variables, ajoutez :

```bash
# Base de donn√©es (cr√©√© automatiquement par Railway)
DATABASE_URL=<auto-generated-by-railway>

# Django
SECRET_KEY=<g√©n√©rez-une-cl√©-secr√®te-al√©atoire>
DEBUG=False
ALLOWED_HOSTS=*.railway.app,your-app-name.railway.app

# CORS - Remplacez par votre URL Vercel
CORS_ALLOWED_ORIGINS=https://your-app.vercel.app,https://your-app-git-main.vercel.app

# Cloudinary (si utilis√©)
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

# Twilio (si utilis√© pour SMS)
TWILIO_ACCOUNT_SID=your-account-sid
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=your-phone-number

# Redis (optionnel, pour WebSockets)
REDIS_HOST=redis.railway.app
REDIS_PORT=6379
REDIS_PASSWORD=<from-redis-service-if-added>
```

### √âtape 5 : Configurer le Build

Dans Railway ‚Üí Settings ‚Üí Build & Deploy :

**Build Command :**
```bash
pip install -r requirements.txt
```

**Start Command :**
```bash
python manage.py migrate && python manage.py collectstatic --noinput && gunicorn campuslink.wsgi:application --bind 0.0.0.0:$PORT
```

### √âtape 6 : Cr√©er requirements.txt pour Production

Cr√©ez/modifiez `backend/requirements.txt` :

```txt
Django>=4.2.0
djangorestframework
djangorestframework-simplejwt
django-cors-headers
psycopg2-binary
gunicorn
whitenoise
python-decouple
django-environ
channels
channels-redis
celery
redis
twilio
cloudinary
django-cloudinary-storage
drf-yasg
django-filter
Pillow
```

### √âtape 7 : Cr√©er Procfile (optionnel)

Cr√©ez `backend/Procfile` :

```
web: python manage.py migrate && python manage.py collectstatic --noinput && gunicorn campuslink.wsgi:application --bind 0.0.0.0:$PORT
worker: celery -A campuslink worker --loglevel=info
```

### √âtape 8 : Mettre √† jour settings.py pour Production

Ajoutez dans `backend/campuslink/settings.py` :

```python
# Production settings
if not DEBUG:
    # Security settings
    SECURE_SSL_REDIRECT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_CONTENT_TYPE_NOSNIFF = True
    X_FRAME_OPTIONS = 'DENY'
    
    # Static files with WhiteNoise
    STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
    MIDDLEWARE.insert(1, 'whitenoise.middleware.WhiteNoiseMiddleware')
```

### √âtape 9 : D√©ployer

1. Railway d√©ploiera automatiquement √† chaque push sur `main`
2. V√©rifiez les logs dans Railway Dashboard
3. Votre API sera disponible sur `https://your-app.railway.app`

### √âtape 10 : Cr√©er un Superuser

Dans Railway ‚Üí Service ‚Üí Deploy Logs ‚Üí Terminal :

```bash
python manage.py createsuperuser
```

## üîß Configuration CORS

Dans `backend/campuslink/settings.py`, ajoutez votre URL Vercel :

```python
CORS_ALLOWED_ORIGINS = [
    "https://your-app.vercel.app",
    "https://your-app-git-main.vercel.app",  # Preview deployments
    "https://your-app-git-*-your-username.vercel.app",  # Tous les previews
]
```

## üìù Checklist

- [ ] Projet Railway cr√©√©
- [ ] PostgreSQL ajout√© et configur√©
- [ ] Service Django configur√©
- [ ] Variables d'environnement ajout√©es
- [ ] Build command configur√©
- [ ] Start command configur√©
- [ ] Migrations appliqu√©es
- [ ] Superuser cr√©√©
- [ ] API accessible (testez `/api/events/`)
- [ ] CORS configur√© pour Vercel

## üêõ D√©pannage

### Erreur : "No module named 'gunicorn'"
- Ajoutez `gunicorn` dans `requirements.txt`

### Erreur : "Static files not found"
- V√©rifiez que `collectstatic` est dans le start command
- V√©rifiez que WhiteNoise est configur√©

### Erreur : "Database connection failed"
- V√©rifiez que `DATABASE_URL` est bien configur√©
- V√©rifiez que PostgreSQL est d√©marr√©

### Erreur CORS
- V√©rifiez que votre URL Vercel est dans `CORS_ALLOWED_ORIGINS`
- Red√©ployez apr√®s modification

## üîó Obtenir l'URL de votre Backend

1. Dans Railway ‚Üí Service ‚Üí Settings
2. Cliquez sur "Generate Domain"
3. Copiez l'URL (ex: `https://campuslink-production.up.railway.app`)
4. Utilisez cette URL dans Vercel comme `NEXT_PUBLIC_API_URL`

